<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - SportifyField</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo">
                    <img src="Asset/Navbar.png" alt="SportifyField Logo" class="logo-img">
                    <span class="logo-text">SportifyField</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Reset Password Section -->
    <section class="login-section">
        <div class="container">
            <div class="login-card">
                <div class="login-icon-wrapper">
                    <div class="login-icon">
                        <i class="fas fa-key" style="color: white; font-size: 24px;"></i>
                    </div>
                </div>

                <h2 class="login-title">Reset Password Baru</h2>
                <p class="login-subtitle">Silakan masukkan kata sandi baru untuk akun Anda.</p>

                <!-- Initial Loading -->
                <div id="pageLoader" style="margin-bottom: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-red);"></i>
                    <p style="margin-top: 10px;">Memverifikasi link...</p>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" class="alert-message alert-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorText">Link tidak valid atau kadaluarsa.</span>
                </div>

                <!-- Success Message -->
                <div id="successMessage" class="alert-message alert-success" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <span>Password berhasil diubah! Mengarahkan ke login...</span>
                </div>

                <!-- Reset Form -->
                <div class="login-form" id="resetForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Password Baru</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="newPassword" placeholder="Minimal 6 karakter" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Konfirmasi Password</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="confirmPassword" placeholder="Ulangi password baru" required>
                        </div>
                    </div>

                    <button type="button" id="submitBtn" class="btn-login">
                        <span id="btnText">Simpan Password Baru</span>
                        <i id="btnLoader" class="fas fa-spinner fa-spin" style="display: none;"></i>
                    </button>
                </div>

                <div class="login-footer">
                    <a href="login.html" class="back-link">Kembali ke Halaman Login</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p style="text-align:center;">Â© 2024 SportifyField</p>
        </div>
    </footer>

    <!-- FIREBASE RESET LOGIC -->
    <script type="module">
        import { verifyResetCode, confirmNewPassword } from "./auth.js";

        const pageLoader = document.getElementById('pageLoader');
        const resetForm = document.getElementById('resetForm');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const successMessage = document.getElementById('successMessage');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');

        // Get oobCode from URL
        const urlParams = new URLSearchParams(window.location.search);
        const oobCode = urlParams.get('oobCode');
        const mode = urlParams.get('mode');

        // Handle verify
        async function init() {
            if (!oobCode || mode !== 'resetPassword') {
                pageLoader.style.display = 'none';
                errorMessage.style.display = 'flex';
                errorText.textContent = 'Link tidak valid. Pastikan Anda membuka link dari email.';
                return;
            }

            try {
                // Verify the code
                await verifyResetCode(oobCode);

                // If valid, show form
                pageLoader.style.display = 'none';
                resetForm.style.display = 'block';
            } catch (error) {
                console.error("Verify error:", error);
                pageLoader.style.display = 'none';
                errorMessage.style.display = 'flex';
                errorText.textContent = 'Link sudah kadaluarsa atau sudah digunakan.';
            }
        }

        init();

        // Handle Submit
        submitBtn.addEventListener('click', async () => {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            errorMessage.style.display = 'none';

            if (newPass.length < 6) {
                errorText.textContent = 'Password minimal 6 karakter';
                errorMessage.style.display = 'flex';
                return;
            }

            if (newPass !== confirmPass) {
                errorText.textContent = 'Password tidak sama';
                errorMessage.style.display = 'flex';
                return;
            }

            // Loading state
            btnText.textContent = 'Menyimpan...';
            btnLoader.style.display = 'inline-block';
            submitBtn.disabled = true;

            try {
                await confirmNewPassword(oobCode, newPass);

                resetForm.style.display = 'none';
                successMessage.style.display = 'flex';

                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);

            } catch (error) {
                console.error("Confirm error:", error);
                errorText.textContent = 'Gagal menyimpan password. Silakan coba lagi.';
                errorMessage.style.display = 'flex';

                btnText.textContent = 'Simpan Password Baru';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    </script>

    <script src="script.js"></script>
</body>

</html>